import React, { useState, useRef, useEffect } from 'react';
import { useAuth } from '../../../contexts/useAuth';
import Button from '../Button/Button';
import './UserProfile.css';

export interface UserProfileProps {
  className?: string;
}

const UserProfile: React.FC<UserProfileProps> = ({ className = '' }) => {
  const { user, logout } = useAuth();
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  if (!user) {
    return null;
  }

  const toggleDropdown = () => {
    setIsDropdownOpen(!isDropdownOpen);
  };

  const handleLogout = () => {
    logout();
    setIsDropdownOpen(false);
  };

  const getInitials = (email: string) => {
    return email.split('@')[0].slice(0, 2).toUpperCase();
  };

  const getRoleDisplayName = (role: string) => {
    switch (role.toLowerCase()) {
      case 'gestor':
        return 'Gestor';
      case 'consultor':
        return 'Consultor';
      case 'investidor':
        return 'Investidor';
      default:
        return role;
    }
  };

  return (
    <div className={`tsf-user-profile ${className}`} ref={dropdownRef}>
      <button
        className="tsf-user-profile__trigger"
        onClick={toggleDropdown}
        aria-label="User menu"
      >
        <div className="tsf-user-profile__avatar">
          {getInitials(user.email)}
        </div>
        <div className="tsf-user-profile__info">
          <span className="tsf-user-profile__email">{user.email}</span>
          <span className="tsf-user-profile__role">{getRoleDisplayName(user.role)}</span>
        </div>
        <svg
          className={`tsf-user-profile__chevron ${isDropdownOpen ? 'tsf-user-profile__chevron--open' : ''}`}
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4 6L8 10L12 6"
            stroke="currentColor"
            strokeWidth="1.5"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
        </svg>
      </button>

      {isDropdownOpen && (
        <div className="tsf-user-profile__dropdown">
          <div className="tsf-user-profile__dropdown-header">
            <div className="tsf-user-profile__dropdown-avatar">
              {getInitials(user.email)}
            </div>
            <div className="tsf-user-profile__dropdown-info">
              <p className="tsf-user-profile__dropdown-email">{user.email}</p>
              <p className="tsf-user-profile__dropdown-role">{getRoleDisplayName(user.role)}</p>
              {user.status && (
                <span className={`tsf-user-profile__status tsf-user-profile__status--${user.status.toLowerCase()}`}>
                  {user.status}
                </span>
              )}
            </div>
          </div>

          <div className="tsf-user-profile__dropdown-divider" />

          <div className="tsf-user-profile__dropdown-actions">
            <Button
              variant="ghost"
              size="sm"
              fullWidth
              onClick={() => {
                // TODO: Implement profile settings
                setIsDropdownOpen(false);
              }}
              className="tsf-user-profile__dropdown-action"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M13.4595 9.5435C13.3906 9.73026 13.3906 9.93757 13.4595 10.1243C13.5284 10.3111 13.6598 10.4687 13.8305 10.5705L13.8795 10.5995C14.0137 10.6771 14.1286 10.7841 14.2161 10.9135C14.3037 11.0429 14.3618 11.1914 14.3861 11.3471C14.4103 11.5028 14.4002 11.662 14.3565 11.8132C14.3127 11.9644 14.2363 12.1043 14.1325 12.222C14.0286 12.3397 13.8998 12.4332 13.7548 12.4958C13.6098 12.5584 13.4522 12.5887 13.2935 12.5845C13.1348 12.5803 12.9791 12.5416 12.8375 12.471L12.7885 12.442C12.6178 12.3485 12.4205 12.3159 12.2275 12.3485C12.0345 12.3812 11.858 12.4776 11.7235 12.6235C11.5889 12.7694 11.5035 12.956 11.4795 13.154C11.4554 13.352 11.4938 13.552 11.5895 13.726V13.726C11.6617 13.8588 11.7031 14.0074 11.7104 14.1599C11.7177 14.3124 11.6907 14.4644 11.6314 14.6035C11.5721 14.7427 11.482 14.8651 11.3686 14.9613C11.2551 15.0575 11.1213 15.1248 10.9775 15.158C10.8336 15.1912 10.6836 15.1895 10.5405 15.153C10.3973 15.1165 10.2649 15.046 10.1535 14.9475C10.0421 14.849 9.95436 14.7252 9.89647 14.586C9.83858 14.4467 9.81217 14.2954 9.81925 14.144V14.0805C9.81925 13.8692 9.73548 13.6665 9.58545 13.5165C9.43542 13.3664 9.2327 13.2827 9.02125 13.2827C8.8098 13.2827 8.60708 13.3664 8.45705 13.5165C8.30702 13.6665 8.22325 13.8692 8.22325 14.0805V14.144C8.22325 14.3667 8.13504 14.5803 7.97757 14.7378C7.8201 14.8952 7.60653 14.9835 7.38375 14.9835C7.16097 14.9835 6.9474 14.8952 6.78993 14.7378C6.63246 14.5803 6.54425 14.3667 6.54425 14.144V14.0695C6.52037 13.8715 6.43485 13.6848 6.30037 13.5393C6.16589 13.3937 5.98941 13.2973 5.79642 13.2646C5.60343 13.232 5.40611 13.2647 5.23525 13.358L5.18625 13.387C5.04461 13.4576 4.88892 13.4963 4.73028 13.5006C4.57164 13.5048 4.41399 13.4745 4.26902 13.4119C4.12405 13.3493 3.99522 13.2559 3.89149 13.1381C3.78775 13.0204 3.71137 12.8805 3.66765 12.7293C3.62393 12.5781 3.61376 12.4189 3.6378 12.2632C3.66185 12.1075 3.71956 11.959 3.80725 11.8295C3.89494 11.7001 4.00986 11.5931 4.144 11.5155L4.193 11.4865C4.36367 11.3846 4.49508 11.2271 4.56397 11.0403C4.63286 10.8536 4.63286 10.6463 4.56397 10.4595C4.49508 10.2728 4.36367 10.1153 4.193 10.0135L4.144 9.9845C4.00986 9.90683 3.89494 9.79988 3.80725 9.67043C3.71956 9.54097 3.66185 9.39247 3.6378 9.23677C3.61376 9.08107 3.62393 8.92186 3.66765 8.77067C3.71137 8.61948 3.78775 8.47954 3.89149 8.36186C3.99522 8.24418 4.12405 8.15076 4.26902 8.08813C4.41399 8.02551 4.57164 7.99518 4.73028 7.99943C4.88892 8.00367 5.04461 8.04237 5.18625 8.113L5.23525 8.142C5.40611 8.23534 5.60343 8.26802 5.79642 8.23536C5.98941 8.2027 6.16589 8.10629 6.30037 7.96074C6.43485 7.8152 6.52037 7.62848 6.54425 7.43048V7.3805C6.54425 7.15772 6.63246 6.94415 6.78993 6.78668C6.9474 6.62921 7.16097 6.541 7.38375 6.541C7.60653 6.541 7.8201 6.62921 7.97757 6.78668C8.13504 6.94415 8.22325 7.15772 8.22325 7.3805V7.455C8.24713 7.65298 8.33265 7.8397 8.46713 7.98524C8.60161 8.13079 8.77809 8.2272 8.97108 8.25986C9.16407 8.29252 9.36139 8.25984 9.53225 8.1665L9.58125 8.1375C9.72289 8.06692 9.87858 8.02823 10.0372 8.02398C10.1958 8.01974 10.3535 8.05006 10.4985 8.11269C10.6434 8.17532 10.7723 8.26874 10.876 8.38642C10.9797 8.5041 11.0561 8.64404 11.0998 8.79523C11.1436 8.94642 11.1537 9.10563 11.1297 9.26133C11.1056 9.41703 11.0479 9.56553 10.9602 9.69498C10.8725 9.82444 10.7576 9.93139 10.6235 10.009L10.5745 10.038C10.4038 10.1398 10.2724 10.2973 10.2035 10.4841C10.1346 10.6708 10.1346 10.8781 10.2035 11.0649C10.2724 11.2516 10.4038 11.4091 10.5745 11.511L10.6235 11.54C10.7576 11.6176 10.8725 11.7246 10.9602 11.854C11.0479 11.9835 11.1056 12.132 11.1297 12.2877C11.1537 12.4434 11.1436 12.6026 11.0998 12.7538C11.0561 12.905 10.9797 13.0449 10.876 13.1626C10.7723 13.2803 10.6434 13.3737 10.4985 13.4363C10.3535 13.4989 10.1958 13.5293 10.0372 13.525C9.87858 13.5208 9.72289 13.4821 9.58125 13.4115L9.53225 13.3825C9.36139 13.2892 9.16407 13.2565 8.97108 13.2891C8.77809 13.3218 8.60161 13.4182 8.46713 13.5638C8.33265 13.7093 8.24713 13.896 8.22325 14.094V14.144C8.22325 14.3667 8.13504 14.5803 7.97757 14.7378C7.8201 14.8952 7.60653 14.9835 7.38375 14.9835C7.16097 14.9835 6.9474 14.8952 6.78993 14.7378C6.63246 14.5803 6.54425 14.3667 6.54425 14.144V14.0695C6.52037 13.8715 6.43485 13.6848 6.30037 13.5393C6.16589 13.3937 5.98941 13.2973 5.79642 13.2646C5.60343 13.232 5.40611 13.2647 5.23525 13.358L5.18625 13.387C5.04461 13.4576 4.88892 13.4963 4.73028 13.5006C4.57164 13.5048 4.41399 13.4745 4.26902 13.4119C4.12405 13.3493 3.99522 13.2559 3.89149 13.1381C3.78775 13.0204 3.71137 12.8805 3.66765 12.7293C3.62393 12.5781 3.61376 12.4189 3.6378 12.2632C3.66185 12.1075 3.71956 11.959 3.80725 11.8295C3.89494 11.7001 4.00986 11.5931 4.144 11.5155L4.193 11.4865C4.36367 11.3846 4.49508 11.2271 4.56397 11.0403C4.63286 10.8536 4.63286 10.6463 4.56397 10.4595C4.49508 10.2728 4.36367 10.1153 4.193 10.0135L4.144 9.9845C4.00986 9.90683 3.89494 9.79988 3.80725 9.67043C3.71956 9.54097 3.66185 9.39247 3.6378 9.23677C3.61376 9.08107 3.62393 8.92186 3.66765 8.77067C3.71137 8.61948 3.78775 8.47954 3.89149 8.36186C3.99522 8.24418 4.12405 8.15076 4.26902 8.08813C4.41399 8.02551 4.57164 7.99518 4.73028 7.99943C4.88892 8.00367 5.04461 8.04237 5.18625 8.113L5.23525 8.142C5.40611 8.23534 5.60343 8.26802 5.79642 8.23536C5.98941 8.2027 6.16589 8.10629 6.30037 7.96074C6.43485 7.8152 6.52037 7.62848 6.54425 7.43048V7.3805C6.54425 7.15772 6.63246 6.94415 6.78993 6.78668C6.9474 6.62921 7.16097 6.541 7.38375 6.541C7.60653 6.541 7.8201 6.62921 7.97757 6.78668C8.13504 6.94415 8.22325 7.15772 8.22325 7.3805V7.455C8.24713 7.65298 8.33265 7.8397 8.46713 7.98524C8.60161 8.13079 8.77809 8.2272 8.97108 8.25986C9.16407 8.29252 9.36139 8.25984 9.53225 8.1665L9.58125 8.1375C9.72289 8.06692 9.87858 8.02823 10.0372 8.02398C10.1958 8.01974 10.3535 8.05006 10.4985 8.11269C10.6434 8.17532 10.7723 8.26874 10.876 8.38642C10.9797 8.5041 11.0561 8.64404 11.0998 8.79523C11.1436 8.94642 11.1537 9.10563 11.1297 9.26133C11.1056 9.41703 11.0479 9.56553 10.9602 9.69498C10.8725 9.82444 10.7576 9.93139 10.6235 10.009L10.5745 10.038C10.4038 10.1398 10.2724 10.2973 10.2035 10.4841C10.1346 10.6708 10.1346 10.8781 10.2035 11.0649C10.2724 11.2516 10.4038 11.4091 10.5745 11.511L10.6235 11.54C10.7576 11.6176 10.8725 11.7246 10.9602 11.854C11.0479 11.9835 11.1056 12.132 11.1297 12.2877C11.1537 12.4434 11.1436 12.6026 11.0998 12.7538C11.0561 12.905 10.9797 13.0449 10.876 13.1626C10.7723 13.2803 10.6434 13.3737 10.4985 13.4363C10.3535 13.4989 10.1958 13.5293 10.0372 13.525C9.87858 13.5208 9.72289 13.4821 9.58125 13.4115L9.53225 13.3825C9.36139 13.2892 9.16407 13.2565 8.97108 13.2891C8.77809 13.3218 8.60161 13.4182 8.46713 13.5638C8.33265 13.7093 8.24713 13.896 8.22325 14.094V14.144C8.22325 14.3667 8.13504 14.5803 7.97757 14.7378C7.8201 14.8952 7.60653 14.9835 7.38375 14.9835C7.16097 14.9835 6.9474 14.8952 6.78993 14.7378C6.63246 14.5803 6.54425 14.3667 6.54425 14.144V14.0695C6.52037 13.8715 6.43485 13.6848 6.30037 13.5393C6.16589 13.3937 5.98941 13.2973 5.79642 13.2646C5.60343 13.232 5.40611 13.2647 5.23525 13.358L5.18625 13.387C5.04461 13.4576 4.88892 13.4963 4.73028 13.5006C4.57164 13.5048 4.41399 13.4745 4.26902 13.4119C4.12405 13.3493 3.99522 13.2559 3.89149 13.1381C3.78775 13.0204 3.71137 12.8805 3.66765 12.7293C3.62393 12.5781 3.61376 12.4189 3.6378 12.2632C3.66185 12.1075 3.71956 11.959 3.80725 11.8295C3.89494 11.7001 4.00986 11.5931 4.144 11.5155L4.193 11.4865C4.36367 11.3846 4.49508 11.2271 4.56397 11.0403C4.63286 10.8536 4.63286 10.6463 4.56397 10.4595C4.49508 10.2728 4.36367 10.1153 4.193 10.0135L4.144 9.9845C4.00986 9.90683 3.89494 9.79988 3.80725 9.67043C3.71956 9.54097 3.66185 9.39247 3.6378 9.23677C3.61376 9.08107 3.62393 8.92186 3.66765 8.77067C3.71137 8.61948 3.78775 8.47954 3.89149 8.36186C3.99522 8.24418 4.12405 8.15076 4.26902 8.08813C4.41399 8.02551 4.57164 7.99518 4.73028 7.99943C4.88892 8.00367 5.04461 8.04237 5.18625 8.113L5.23525 8.142C5.40611 8.23534 5.60343 8.26802 5.79642 8.23536C5.98941 8.2027 6.16589 8.10629 6.30037 7.96074C6.43485 7.8152 6.52037 7.62848 6.54425 7.43048V7.3805C6.54425 7.15772 6.63246 6.94415 6.78993 6.78668C6.9474 6.62921 7.16097 6.541 7.38375 6.541C7.60653 6.541 7.8201 6.62921 7.97757 6.78668C8.13504 6.94415 8.22325 7.15772 8.22325 7.3805V7.455C8.24713 7.65298 8.33265 7.8397 8.46713 7.98524C8.60161 8.13079 8.77809 8.2272 8.97108 8.25986C9.16407 8.29252 9.36139 8.25984 9.53225 8.1665L9.58125 8.1375C9.72289 8.06692 9.87858 8.02823 10.0372 8.02398C10.1958 8.01974 10.3535 8.05006 10.4985 8.11269C10.6434 8.17532 10.7723 8.26874 10.876 8.38642C10.9797 8.5041 11.0561 8.64404 11.0998 8.79523C11.1436 8.94642 11.1537 9.10563 11.1297 9.26133C11.1056 9.41703 11.0479 9.56553 10.9602 9.69498C10.8725 9.82444 10.7576 9.93139 10.6235 10.009L10.5745 10.038C10.4038 10.1398 10.2724 10.2973 10.2035 10.4841C10.1346 10.6708 10.1346 10.8781 10.2035 11.0649C10.2724 11.2516 10.4038 11.4091 10.5745 11.511L10.6235 11.54C10.7576 11.6176 10.8725 11.7246 10.9602 11.854C11.0479 11.9835 11.1056 12.132 11.1297 12.2877C11.1537 12.4434 11.1436 12.6026 11.0998 12.7538C11.0561 12.905 10.9797 13.0449 10.876 13.1626C10.7723 13.2803 10.6434 13.3737 10.4985 13.4363C10.3535 13.4989 10.1958 13.5293 10.0372 13.525C9.87858 13.5208 9.72289 13.4821 9.58125 13.4115L9.53225 13.3825C9.36139 13.2892 9.16407 13.2565 8.97108 13.2891C8.77809 13.3218 8.60161 13.4182 8.46713 13.5638C8.33265 13.7093 8.24713 13.896 8.22325 14.094V14.144C8.22325 14.3667 8.13504 14.5803 7.97757 14.7378C7.8201 14.8952 7.60653 14.9835 7.38375 14.9835Z"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
              Configurações
            </Button>

            <Button
              variant="ghost"
              size="sm"
              fullWidth
              onClick={handleLogout}
              className="tsf-user-profile__dropdown-action tsf-user-profile__logout"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M11.3333 11.3333L14 8.66667L11.3333 6"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M14 8.66667H6"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M6 2H3.33333C2.97971 2 2.64057 2.14048 2.39052 2.39052C2.14048 2.64057 2 2.97971 2 3.33333V12.6667C2 13.0203 2.14048 13.3594 2.39052 13.6095C2.64057 13.8595 2.97971 14 3.33333 14H6"
                  stroke="currentColor"
                  strokeWidth="1.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
              Sair
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default UserProfile;